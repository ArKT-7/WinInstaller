#!/sbin/bash
#
# Copyright (C) 2023-24 https://github.com/Kumar-Jy
#
# Made for WINDOWS Installation on ......... (code name) 
#
ui_print "*************************************************";
ui_print "* Welcome to Windows Installation on .......... *";
ui_print "*         This Script is only for ....          *";
ui_print "*                Made by Kumar_Jy               *";
ui_print "*       Telegram : https://t.me/Kumar_Jy        *";
ui_print "*     Github  : https://github.com/Kumar-Jy     *";
ui_print "*************************************************";
ui_print "*           Installation Process Start          *";
ui_print "*************************************************";
ui_print "*  extracting boot and modem to /cust/backup     *"
mount /cust /cust
mkdir /cust/backup
dd if=/dev/block/by-name/boot$(getprop ro.boot.slot_suffix) of=/cust/backup/boot.img
dd if=/dev/block/bootdevice/by-name/fsc of=/cust/backup/fsc
dd if=/dev/block/bootdevice/by-name/fsg of=/cust/backup/fsg
dd if=/dev/block/bootdevice/by-name/modemst1 of=/cust/backup/modemst1
dd if=/dev/block/bootdevice/by-name/modemst2 of=/cust/backup/modemst2
ui_print "*************************************************";
ui_print "*               Unmounting Partition            *";
umount /dev/block/by-name/esp
umount /dev/block/by-name/win
sleep 1
ui_print "*************************************************";
ui_print "*                Formating Partition            *";
mkfs.fat -F32 -s1 /dev/block/by-name/esp -n ESP
mkfs.ntfs -f /dev/block/by/name/win -L WIN
sleep 1
ui_print "*************************************************";
ui_print "*                Mounting Partition             *";
mkdir /mnt/win
mkdir /mnt/esp
mount.ntfs /dev/block/by-name/win /mnt/win
mount /dev/block/by-name/esp /mnt/esp
sleep 1
ui_print "*************************************************";
ui_print "*              Copy Installation File           *";
mkdir /mnt/win/installer
mkdir /mnt/win/installer/Driver
package_extract_file "pe" "/mnt/win/installer/pe";
package_extract_file "install.esd" "/mnt/win/installer/install.esd";
package_extract_file "Driver.zip" "/mnt/win/installer/Driver.zip";
package_extract_file "uefi.img" "/mnt/win/installer/uefi.img";
package_extract_file "winactivator.bat" "/mnt/win/winactivator.bat";
package_extract_file "install.bat" "/mnt/win/installer/install.bat";
unzip /win/installer/Driver.zip -d /mnt/win/installer/Driver
sleep 1
ui_print "*************************************************";
ui_print "*     flashing uefi image to boot partition     *";
mkdir /sdcard/backup
cp -r -n /cust/backup -d /sdcard
cp /cust/backup/boot.img -d /mnt/win/boot.img
rm /sdcard/UEFI/*.img
mkdir /sdcard/UEFI
cp -r -n /mnt/win/installer/uefi.img -d /sdcard/UEFI/uefi.img
dd if=/mnt/win/installer/pe of=/dev/block/by-name/esp
dd if=/mnt/win/installer/uefi.img of=/dev/block/by-name/boot$(getprop ro.boot.slot_suffix)
sleep 1
ui_print "*************************************************";
ui_print "*              Flashing Completed               *";
ui_print "*                                               *";
ui_print "*             rebooting in 5 sec and            *";
ui_print "*                                               *";
ui_print "*     Installation will start automaticly       *";
ui_print "*                                               *";
ui_print "*  If Installation Failed, Don't Flash it again *";
ui_print "*                                               *";
ui_print "*         ask for help on Telegram Chat         *";
ui_print "*                                               *";
ui_print "*************************************************";
sleep 5
reboot
