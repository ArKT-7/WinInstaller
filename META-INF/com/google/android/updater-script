#!/sbin/bash
#
# Copyright (C) 2025-26 https://github.com/Kumar-jy, https://github.com/ArKT-7
#
# Made for Windows Installation on WOA Devices 
#

#=======================Configrations=======================
device_code="nabu" # Check and verify device with its codename
path="/dev/block/by-name"  # Base path to named partition symlinks
win_path="$path/win"  # Windows partition block name
win_min_size=30  # in GB
esp_path="$path/esp"  # ESP partition block name
esp_min_size=349  # in MB
current_battery_level=$(cat /sys/class/power_supply/battery/capacity)
min_required_battery=50  # Minimum required battery percentage to proceed
partition_backup="boot dtbo vendor_boot fsc fsg modemst1 modemst2 persist" # set partiiton to backup auto handgle A/B non A/B device
win_part_name="WINNABU"  # Partiton name for format
WINDOWS_EDITIONS=(
    "Windows 11 Pro"
    "Windows 11 IoT Enterprise LTSC"
    "Windows 11 Enterprise"
    "Windows 11 Home"
    "Windows 10 Pro"
    "Windows 10 Home"
)
#===========================================================

ui_print "*===============================================*"
ui_print "*Welcome to Windows Installation on Xiaomi Pad 5*"
ui_print "*        Version: WinInstaller_Nabu_R8.2.5      *"
ui_print "*        Date   : 05-May-2025                   *"
ui_print "*        Made by: Kumar_Jy & ArKT               *"
ui_print "*   Help and suggestions by: Sog, Andre_grams   *"
ui_print "*Drivers & UEFI: Project-Aloha,map220v,remtrik..*"
ui_print "*===============================================*"
verify_device "$device_code"
ui_print "*           Verifying Partition Size            *"
verify_part
ui_print "*-----------------------------------------------*"
ui_print "*            Checking Battery Status            *"
verify_battery
ui_print "*-----------------------------------------------*"
ui_print "*                   Fixing GPT                  *"
aio_progress 0.4 10
setup_gdisk
#to-do loop in all available device 
for i in a b c d e f; do  
    DEVICE="/dev/block/sd$i"
    run_gdisk "$DEVICE"
done
ui_print "*-----------------------------------------------*"
ui_print "*  Extracting boot and modem to /sdcard/backup  *"
backup_partitions $partition_backup
ui_print "*-----------------------------------------------*"
ui_print "*   Checking if Windows is already installed    *"
ui_print "*-----------------------------------------------*"
aio_progress 0.3 0
aio_progress 0.9 100
setup_wimlib
if is_windows_installed; then
    ui_print "*          Windows is already installed         *"
    #to-do add volume button selection to choose re-install again with windows format or continue
    if is_partition_rw; then
        ui_print "*         Skipping format and copy steps        *"
        ui_print "*    and processing for Drivers Installation    *"
    else
        ui_print " "
        ui_print "*---------------------Error!--------------------*"
        ui_print "          Error: Partition is Read-Only         "
        ui_print "Goto Windows then reboot to Android and try again"
        ui_print " "
        umount "$win_path"
        exit 1
    fi
else
    ui_print "*        Windows is not already installed       *"
    ui_print "*       Proceeding with Windows Installation    *"
    ui_print "*-----------------------------------------------*"
    ui_print "*           Searching for Windows Image         *"
    win_esd_search
    ui_print "*-----------------------------------------------*"
    ui_print "*           Verifying Windows Edition           *"
    find_index
    ui_print "*-----------------------------------------------*"
    ui_print "   Installing $SELECTED_EDITION ...."
    format_win
    exit
    "$UPD_TEMP_FOLDER/wimlib-imagex" apply "$WIN_IMAGE" "$SELECTED_INDEX" "$win_path"
fi

if ! is_windows_installed; then
    ui_print " "
    ui_print "*---------------------Error!--------------------*"
    ui_print "Failed to install $SELECTED_EDITION, ESD/WIM file may be corrupted..."
    ui_print "Reboot to Android and check the ESD/WIM image."
    ui_print " "
    umount "$win_path"
    exit 1
fi

aio_progress 0.5 0
aio_progress 0.9 20
#After this idk if i'll do modular, but not need ig, idk also already added handle non A/B device in oneliner like before
ui_print "*-----------------------------------------------*"
ui_print "*         Extracting Installation File          *";
package_extract_folder "installer" "$WIN_MOUNT_FOLDER"
package_extract_folder "ToolBox" "$WIN_MOUNT_FOLDER"
package_extract_file "woahelper.apk" "/sdcard/woahelper.apk"
ui_print "*-----------------------------------------------*"
ui_print "*               Flashing UEFI image             *"
rm /sdcard/UEFI/*.img
mkdir -p /sdcard/UEFI
dd if="$WIN_MOUNT_FOLDER/installer/uefi.img" of="/sdcard/UEFI/uefi.img" bs=1M || { umount "$win_path" "$esp_path"; ui_print "Error copying uefi.img"; exit 1; }
dd if="/sdcard/backup/boot$(getprop ro.boot.slot_suffix).img" of="$WIN_MOUNT_FOLDER/boot.img" bs=1M 2>/dev/null || dd if="/sdcard/backup/boot.img" of="$WIN_MOUNT_FOLDER/boot.img" bs=1M || { umount "$win_path" "$esp_path"; ui_print "Error copying boot.img in Windows"; exit 1; }
dd if="$WIN_MOUNT_FOLDER/installer/pe.img" of="$path/esp" bs=1M || { umount "$win_path" "$esp_path"; ui_print "Error flashingh WinPE.img"; exit 1; }
dd if="$WIN_MOUNT_FOLDER/installer/uefi.img" of="$path/boot$(getprop ro.boot.slot_suffix)" bs=1M 2>/dev/null || dd if="$WIN_MOUNT_FOLDER/installer/uefi.img" of="$path/boot" bs=1M || { umount "$win_path" "$esp_path"; ui_print "Error flashing uefi on boot partition"; exit 1; }
umount "$win_path" "$esp_path"
sleep 1
ui_print "*===============================================*"
ui_print "*   Flashing Completed, Now reboot to system    *"
ui_print "*                                               *"
ui_print "*     Installation will start automatically     *"
ui_print "*                                               *"
ui_print "*      If it fails, Don't Flash it again        *"
ui_print "*                                               *"
ui_print "*    ask for help on Telegram: @wininstaller    *"
ui_print "*                                               *"
ui_print "*   Thanks to all WOA Developers & Maintainers  *"
ui_print "*===============================================*"
aio_progress 1.0
exit
